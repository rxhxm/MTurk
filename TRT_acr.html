<head>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8">
</head>



<style type="text/css">
body{font-family:Tahoma,"Times New Roman", Times, serif;}

.table th, .table td {
     border-top: none !important;
}
.center {
    display: block;
    margin-left: auto;
    margin-right: auto;
    width: 30%;
}

.baudio {margin:5px;}
.baudio .baudio_table{display: inline;}
.baudio .bn{margin:10px;}
.baudio td{text-align:center;}
.baudio .blabel{margin-top:50px;font-size: 70%;	color: #636363;}

.scale {font-size: 100%;}
.scale td { text-align: left; padding:0;}
.scale label { display:block;}
.scale .c { text-align: center;}
section {
	margin-bottom:15px;
	padding: 10px 10px;
	font-family: Verdana, Geneva, sans-serif;
	color:#333333;
	font-size:0.9em;
}
fieldset { padding: 10px; background:#fbfbfb; border-radius:5px; margin-bottom:5px; }

.audio-rating {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 20px; /* Adjust as needed */
    margin-bottom: 20px; /* Space between each audio-rating set */
}


.rating-options {
    display: flex;
    justify-content: space-between; /* Distribute space evenly between options */
    width: 100%; /* Ensure the container spans the full width */
}

.rating-option {
    display: flex;
    flex-direction: column;
    justify-content: center; /* Center content vertically */
    align-items: center; /* Center content horizontally */
    flex: 1; /* Distribute space evenly */
    text-align: center; /* Center-align the text */
    min-width: 0; /* Allow the flex items to shrink if necessary */
}

/* Ensure the input and its label are tightly grouped */
.rating-option label {
    display: inline-block;
    white-space: nowrap; /* Keep the label text on one line */
}

/* Optional: Increase spacing between the radio button and its label */
.rating-option input[type="radio"] {
    margin-right: 5px;
}

/* Adjustments for smaller screens */
@media (max-width: 600px) {
    .audio-rating {
        flex-direction: column;
        gap: 10px;
    }
    .rating-options {
        width: auto; /* Adjust width for smaller screens */
        flex-direction: column;
        align-items: center; /* Center-align the options for readability */
    }
    .rating-option {
        width: 100%; /* Full width for better touch targets on small screens */
    }
}

</style>

<script type="text/javascript">

/*
General configuration file:
  - cookieName: change it for each study, it will be used to monitor if the user has taken training, setup sections, and
 how many assignments they submitted to expose limits.
 - qualificationCookieName: name of cookie that shows the status of qualification section.
 - qualificationValidFor: how long the qualification cookie stay in minutes (43200 : 1 month)
 - forceRetrainingInHours: every X hours force the user to take part in training (recommendation: 1hour)
 - showSetupEveryMinutes: show the setup section every X minutes (recommendation: 15 minutes)
 - questionUrls: URLs to clips to be appeared in the Rating section. Either hard-coded or placeholders.
 - trainingUrls: URLs to clips to be appeared in the Training section. Either hard-coded or placeholders.
 - knownQuestionInTrainingUrl: Training may contain a question with known answer which worker will be forced to give the
 correct answer to.
 - knownQuestionInTrainingAns: the answer that should be selected by worker
 - knownQuestionUrl: the rating section may contain a question with known answer. It will be used in combination of the
 Assignment Review Policy.
 - knownQuestionAns: the answer that we expect from worker
 - randomizeTrainingQuestions: boolean whether the questions in the training section should be randomized on loading time.
 - randomizeRatingQuestions: boolean whether the questions in the rating section should be randomized on loading time.
 - allowedMaxHITsInProject: How many HITs each worker is allowed to answer in this project
 - allowedMaxContinuesSessionDurationInMinutes: how log is the maximum continue session. A break of 10min will be forced
*/
var config ={
	cookieName:"itu_p808_sup23_exp3",
	qualificationCookieName:"ACR_LISTENER_01_14_2020",
	qualificationValidFor:43200,
    forceRetrainingInHours:1,
    showSetupEveryMinutes:30,
    debug:"false",
    questionUrls: ['${Q0}', '${Q1}', '${Q2}', '${Q3}', '${Q4}', '${Q5}'],
    trainingUrls: ['https://audiosamplesp808.blob.core.windows.net/sup23/exp3/deg/OE3M5232.wav', 'https://audiosamplesp808.blob.core.windows.net/sup23/exp3/deg/OE3F7D25.wav', 'https://audiosamplesp808.blob.core.windows.net/sup23/exp3/deg/OE3M0202.wav', 'https://audiosamplesp808.blob.core.windows.net/sup23/exp3/deg/OE3M4721.wav', 'https://audiosamplesp808.blob.core.windows.net/sup23/exp3/deg/OE3F9347.wav', 'https://audiosamplesp808.blob.core.windows.net/sup23/exp3/deg/OE3F6B07_bad_short.wav'],

    knownQuestionInTrainingUrl:"https://audiosamplesp808.blob.core.windows.net/sup23/exp3/deg/OE3F6B07_bad_short.wav",
    knownQuestionInTrainingAns: "1",
    knownQuestionUrl:"${TP}",
    knownQuestionAns: "${TP_ANS}",
    goldClipURL:"${gold_clips}",
    goldClipAns:"${gold_clips_ans}",
    randomizeTrainingQuestions:"true",
    randomizeRatingQuestions:"true",
    allowedMaxHITsInProject:60,
	allowedMaxContinuesSessionDurationInMinutes:45,
	qualification:{
		mother_tongue: ["english","en"],
		ld_in: ["in-ear", "over-ear"],
		working_area: "N",
		hearing: "normal",
 		num1: "Mjg5",
        num2: "MzQw",
        num3: "NjI2",
        num4: "NTkx",
        num5: "MzU5"
	},
	cmp_correct_answers: ['aHR0cHM6Ly9hdWRpb3NhbXBsZXNwODA4LmJsb2IuY29yZS53aW5kb3dzLm5ldC9wODA4LWFzc2V0cy9jbGlwcy9zYW1wbGVfam5kLzUwU19mZW1hbGUxLndhdg==', 'aHR0cHM6Ly9hdWRpb3NhbXBsZXNwODA4LmJsb2IuY29yZS53aW5kb3dzLm5ldC9wODA4LWFzc2V0cy9jbGlwcy9zYW1wbGVfam5kLzUwU19mZW1hbGUyLndhdg==', 'aHR0cHM6Ly9hdWRpb3NhbXBsZXNwODA4LmJsb2IuY29yZS53aW5kb3dzLm5ldC9wODA4LWFzc2V0cy9jbGlwcy9zYW1wbGVfam5kLzUwU19tYWxlMS53YXY=', 'aHR0cHM6Ly9hdWRpb3NhbXBsZXNwODA4LmJsb2IuY29yZS53aW5kb3dzLm5ldC9wODA4LWFzc2V0cy9jbGlwcy9zYW1wbGVfam5kLzUwU19tYWxlMi53YXY='],
	cmp_max_n_feedback : 4,
	cmp_pass_threshold: 2,
	emailAddress: "ic3ai@outlook.com",
	// set allowed bandwidth range: "NB-WB", "SWB", "FB"
	bw_min: "NB-WB",
	bw_max: "FB",
}

// if performing of this assignment is already counted
var hitCounterIncreased = false;
// record the errors happened in the page
var generalErrorLog= "";

// how many times a feedback was given to the workers,
var n_cmp_feedbacks = 0;

const Hide_HIT_REASON = Object.freeze({"MAX_ACHIVED":1, "QUALIFICATON":2})
/*
Initializing the page: generate and hide sections depending to the cookies value
*/
$(function() {
	try{
		// disable logs if not debug
		if (!JSON.parse(config['debug'])){
			console.log = function() {};
		}
		loadTextPlaceHolders();
		generate_training_section();
		generate_rating_section();
		avoidAnsweringBeforeListeningThrough();
		cookie_debug_status="";
		// given cookie availability disable the qualification
		qual_passed= readCookie(config['qualificationCookieName']);
		console.log(qual_passed);

		if (qual_passed!==null && qual_passed=="true"){
			$('.qualificationFieldset').prop("disabled", true);
			$("#qualification").hide();
			$("#qualification :input").removeAttr("required");
			cookie_debug_status=cookie_debug_status+"ACR_LISTENER Exist*";
		}
		// given cookie availability disable the training
		if (readCookie(config['cookieName']+"_training")){
			$('.trainingFieldset').prop("disabled", true);
			$("#training").hide();
			$("#training :input").removeAttr("required");
			$('#instruction').collapse()
			cookie_debug_status=cookie_debug_status+"Train Exist*";
		}
		// given cookie availability disable the setup
		if (readCookie(config['cookieName']+"_setup")){
			$('.setupFieldset').prop("disabled", true);
			$("#setup").hide();
			$("#setup :input").removeAttr("required");
			cookie_debug_status=cookie_debug_status+"Setup Exist*";
		}

		hit_num = readCookie(config['cookieName']+"_counter");
		howManyHITsAnswered =0;
		if (hit_num != null ){
			howManyHITsAnswered= Number(hit_num);
			if (howManyHITsAnswered >= config['allowedMaxHITsInProject']){
				disableTheHIT(Hide_HIT_REASON.MAX_ACHIVED);
			}
		}
		if ((qual_passed!==null) && (qual_passed=="false")){
			disableTheHIT(Hide_HIT_REASON.QUALIFICATON);
		}

		hitCounterIncreased = false;
		cookie_debug_status=cookie_debug_status+"Counter:"+howManyHITsAnswered+"*";
		addBrowserInfo(cookie_debug_status);


		// for qualification section
		initializeQualification();
		initializeActivePageMonitoring();
		cmp_check_on_load();
	}catch(err){
		console.error(err);
		recordError(err.name,err.message);

	}
});

var overAllHiddenTime = 0;
var startHiddenDate = null;
var sessionId = null;
var sessionIdVariableName=null;
/**
	monitor and record the status of page including being focus, and active time

**/
function initializeActivePageMonitoring(){
	sessionId = Math.random().toString(36).substr(2, 9);
	sessionIdVariableName = config.qualificationCookieName +"_sid";
	createCookie(sessionIdVariableName,sessionId,70);

	document.addEventListener("visibilitychange", function() {
		var isHidden = document.hidden;
		if (isHidden){
			startHiddenDate = new Date();
		}else{
			//get back the focus
			stopHiddenDate = new Date();
			diff = stopHiddenDate -startHiddenDate;
			overAllHiddenTime = overAllHiddenTime + diff;
			$('#time_page_hidden_sec').val(overAllHiddenTime/1000);
		}
		console.log( "document_hidden: "+ document.hidden + "time: "+overAllHiddenTime);

	});
}

/**
	check if there is any parallel session available.
**/
function isAnyParallelSession(){
	hit_num = readCookie(sessionIdVariableName);
	if (hit_num != sessionId){
		$('#any_parallel_session').val("true");
		console.log("parallel session.")
		return true;
	}
	return false;

}

/**
 central method to record errors
**/
function recordError(name, message){
	generalErrorLog =generalErrorLog + " Error "+name+": "+message+";%0D%0A"
	$('#errors').val(generalErrorLog);
	$("#errorEmail").attr("href","mailto:"+config["emailAddress"]+"?subject=Error on HIT Load&body="+generalErrorLog);
	$("#errorSection").show();
}

/*
	Initialize the qualification section
*/
var qualification_ans= new Set();
function initializeQualification(){
	randomizeHearingtestItems();
    makeCheckboxBeRequired();
    forceNoSpaceInInput();
    $("#qualification :input").on('change', isQualificationDone);
}
/*
	check if the qualification all answered
*/
function isQualificationDone(){
	qualification_ans.add(this.name);
	console.log("check if the qualification is done"+this.name+","+qualification_ans.size);
	validateQualificationAnswer();
	if (qualification_ans.size==18)
		validateQualificationAnswer();
}

/*
	check the qualification passed
*/
function validateQualificationAnswer(){
	m_tongue = $("input[name='3_mother_tongue']").val().toLowerCase().trim();
	m_tongue_check= config.qualification.mother_tongue.includes(m_tongue)

	// check listening devices
	var listening_device = [];
	$.each($("input[name='4_ld']:checked"), function(){
		listening_device.push($(this).val());
	});
	device_check=false;
	for (var i = 0; i < listening_device.length; i++) {
		device_check = device_check || config.qualification.ld_in.includes(listening_device[i]);
	}
	working_area_checked= $("input[name='7_working_area']:checked").val() =="N"
	hearing_self_report_check=$("input[name='8_hearing']:checked").val() == "normal"
	count_correct_ht=0;
	if (checkQualNumCorrect($("input[name='num1']").val().trim(),config.qualification.num1))
		count_correct_ht ++;
	if (checkQualNumCorrect($("input[name='num2']").val().trim(),config.qualification.num2))
		count_correct_ht ++;
	if (checkQualNumCorrect($("input[name='num3']").val().trim(),config.qualification.num3))
		count_correct_ht ++;
	if (checkQualNumCorrect($("input[name='num4']").val().trim(),config.qualification.num4))
		count_correct_ht ++;
	if (checkQualNumCorrect($("input[name='num5']").val().trim(),config.qualification.num5))
		count_correct_ht ++;
	bw_check = validate_bw_test();
	//console.log("count_correct_ht:"+count_correct_ht);
	passed=  m_tongue_check && device_check && working_area_checked &&  hearing_self_report_check && bw_check &&
		count_correct_ht>= 3;
	console.log(passed);
	// add a qualification for 'qualificationValidFor' minutes
	createCookie(config.qualificationCookieName,passed,config.qualificationValidFor);
}

bw_v2_test_data ={
        "comb_bw1":'dq',
        "comb_bw2":'dq',
        "comb_bw3":'dq',
        "comb_bw4":'sq',
        "comb_bw5":'sq',   
    }
/**
 * Validate the band-width check
 **/
function validate_bw_test() {
	data = bw_v2_test_data;
	count_correct = 0;
	ans_array = Array(5).fill(0);
	for (var i = 1; i <6; i++) {
		q_name = 'comb_bw'+i;			
		ans = $("input[name='"+q_name+"']:checked").val();
		if (ans == data[q_name]) 
			ans_array[i-1] = 1;			
		else
			ans_array[i-1] = 0;
	}
	console.log(ans_array);
	bw_min = config['bw_min'].toUpperCase();
	bw_max = config['bw_max'].toUpperCase();
	// convert ans_array to string

	$('#bw_check_details').val(ans_array.join(','));
	

	if (ans_array[0] + ans_array[3] + ans_array[4] !=3){
		// failed in trapping of obvious questions
		bw_text = 'failed'
		$('#bw_check').val(bw_text);
		return false;
	}
	if (ans_array[1]+ans_array[2] == 2){
			bw_text = 'FB'			
		}
	else if (ans_array[1]+ans_array[2] == 1){
			bw_text = 'SWB'
	} else
			bw_text = 'NB-WB'
	$('#bw_check').val(bw_text);

	if ((bw_min == 'SWB' && ans_array[1] != 1) || (bw_min == 'FB' && ans_array[1]+ans_array[2] != 2)){		
		return false;
	}
		
	if ((bw_max == 'NB-WB' && ans_array[1]+ans_array[2] != 0) || (bw_max == 'SWB' && ans_array[2] != 0))
		return false;	
	return true;
}

/*
	randomize clips in the hearing test
*/
function randomizeHearingtestItems(){
    var cards = $(".rnd");
	for(var i = 0; i < cards.length; i++){
		var target = Math.floor(Math.random() * cards.length -1) + 1;
		var target2 = Math.floor(Math.random() * cards.length -1) +1;
		cards.eq(target).before(cards.eq(target2));
    }

	var cards = $(".rnd4");
	for(var i = 0; i < cards.length; i++){
		var target = Math.floor(Math.random() * cards.length -1) + 1;
		var target2 = Math.floor(Math.random() * cards.length -1) +1;
		cards.eq(target).before(cards.eq(target2));
    }

}
/*
	Make a checkbox group to be required
*/
function makeCheckboxBeRequired(){
    var requiredCheckboxes = $('.4_lds :checkbox[required]');
    requiredCheckboxes.change(function(){
        if(requiredCheckboxes.is(':checked')) {
            requiredCheckboxes.removeAttr('required');
        } else {
            requiredCheckboxes.attr('required', 'required');
        }
    });
}
/*
	Avoid space in text field
*/
function forceNoSpaceInInput(){
    $(".nospace").on({
          keydown: function(e) {
            if (e.which === 32)
              return false;
          },
          change: function() {
            this.value = this.value.replace(/\s/g, "");
          }
        });
}

/*
Change placeholders inside text with values from config file.
*/
function loadTextPlaceHolders(){
	// update the instruction
	$('.max_allowed_hits').html(config['allowedMaxHITsInProject']);
	$('.setup_time').html(config['showSetupEveryMinutes']);
	$('.training_time').html(config['forceRetrainingInHours']);

}

/*
Store the following information in hidden input field which will be added to answerc.sv by AMT
userAgent, cookieEnabled, appVersion, platform, language, status of 3 cookies.
*/
function addBrowserInfo(debug){
	info="U_A:"+navigator.userAgent+";"+
		"CookieEnabled:"+navigator.cookieEnabled+";"+
		"AppV:"+navigator.appVersion+";"+
		"Platform:"+navigator.platform+";"+
		"LN:"+navigator.language+";"+
		"cookie_debug:"+debug+";";

	$('#browser_info').val(info);
	console.log(info);

}

//-------- check qual num online
function checkQualNumCorrect(given_ans, correct_hash){
	return btoa(given_ans) == correct_hash;
}
// ------------------------ online check cmp

/*
 check if the answer to a CMP question is correct.
*/
function isCMPAnsCorrect(selected_url){
	// for backward compatibility
	if (!config.hasOwnProperty("correct_cmp_answers"))
		return true;
	b64 = btoa(selected_url);
	return config["correct_cmp_answers"].includes(b64);
}

// add this to onload of page
function cmp_check_on_load(){
	$('#setup').find(':input').filter(':visible').each(function(){
	  $(this).on('change', validateCMPSection);
	});
}

/*
	Validate the answers give to the cmps in the setup section and provide an adequate feedback
*/
function validateCMPSection(){
	// 1. check if all questions are answered
	cmp_answers= [];
	for (i = 1; i < 5; i++) {
		ans = $("input[name='cmp{0}']:checked".f(i)).val();
	  	if (!ans)
	  		return;
	  	cmp_answers.push(ans);
	}
	math_ans = $('#Math').val();
	if (!math_ans)
	  	return;

		// 2. check math question
	// do not check math question now
	// 3. check cmps
	correct_ans = 0 ;
	for (i = 0; i < 4; i++) {
		if (cmp_answers[i] == "o")
			continue;
		url = $('span[id="CMP{0}_{1}"]'.f(i+1, cmp_answers[i].toUpperCase())).attr("data-src");
		if (config["cmp_correct_answers"].includes(btoa(url)))
			correct_ans ++;
	}
	// 4. shows the message if needed
	if (correct_ans >= config["cmp_pass_threshold"]){
		// valid response in cmp
		createCookie(config['cookieName']+"_setup","un_important",config['showSetupEveryMinutes']);
		return;
	}
	removeCookie(config['cookieName']+"_setup");
	if (n_cmp_feedbacks <  config["cmp_max_n_feedback"]){
		n_cmp_feedbacks++;
		msg = "Based on your answers, your environment is NOT quite enough or your setup is NOT good enough. Please make sure to do your task in a quite environment with headset and use both earpods. Try the Setup section again.";
		last_time_msg = " It is the last time you see this feedback.";
		makeAllCMPsUnChecked();
		if (n_cmp_feedbacks ==config["cmp_max_n_feedback"])
			alert(msg+last_time_msg);
		else
			alert(msg);

	}
	// 4.2 remove the listener
	if (n_cmp_feedbacks >=  config["cmp_max_n_feedback"]){
		$('#setup').find(':input').filter(':visible').each(function(){
	  		$(this).off('change');
		});
	}
}

function makeAllCMPsUnChecked(){
	// remove the listeners
	$('#setup').find(':input').filter(':visible').each(function(){
	  		$(this).off('change');
	});
	// uncheck radio <buttons></buttons>
	for (i = 1; i < 5; i++) {
		$("input[name='cmp{0}']:checked".f(i)).prop('checked', false);
	}
	// add the listeners
	cmp_check_on_load()
}

//--------------- Utilities -----------------

/*
	Utility function to format strings
*/
String.prototype.format = String.prototype.f = function() {
    var s = this,
        i = arguments.length;
    while (i--) {
        s = s.replace(new RegExp('\\{' + i + '\\}', 'gm'), arguments[i]);
    }
    return s;
};

/*
	Utility: convert seconds to MM:SS
*/
String.prototype.toMMSS = function () {
    var sec_num = parseInt(this, 10); // don't forget the second param
    var minutes   = Math.floor(sec_num / 60);
    var seconds = sec_num - (minutes * 60);
    if (minutes < 10) {minutes = "0"+minutes;}
    if (seconds < 10) {seconds = "0"+seconds;}
    return minutes+':'+seconds;
}

/*
	Disable the HIS and show a proper message.
	- used when the maximum number of HITs in project is reached
*/
function disableTheHIT(c){
	$("#qualification").hide();
	$("#training").hide();
	$("#setup").hide();
	$("#rating_section").hide();
	$("#Survey").hide();
	$("#thanks").hide();
	$("#device_check_section").hide();

	if (c == Hide_HIT_REASON.MAX_ACHIVED)
		$("#max_allowed_HITs_reached").show();
	if (c == Hide_HIT_REASON.QUALIFICATON)
		$("#qualification_rejected").show();
}

/*
	Add a cookies with corresponding values
*/
function createCookie(name, value, minutes) {
    var expires;
    if (minutes) {
        var date = new Date();
        date.setTime(date.getTime() + (minutes * 60 * 1000));
        expires = date.toGMTString();
    } else {
        expires = "";
    }

    let st =value +";"+ expires ;
    console.log(st);
    localStorage.setItem(name, st);
}

function createCookieOld(name, value, minutes) {
    var expires;
    if (minutes) {
        var date = new Date();
        date.setTime(date.getTime() + (minutes * 60 * 1000));
        expires = "expires=" + date.toGMTString();
    } else {
        expires = "";
    }

    let st = name + "=" + value +";"+ expires + ";path=/";
    console.log(st);
    //document.cookie = encodeURIComponent(name) + "=" + encodeURIComponent(value) + expires + "; path=/";
    document.cookie = st;
}

/*
	Update the cookie which counts the number of Assignments performed by user. Increase it by "updateBy" value.
*/
function updateCounterCookie(name, updateBy){
	expiry_in_a_month= 30*24*60
	c = readCookie(name);
	if (c==null){
		createCookie(name, 1, expiry_in_a_month);
		return 1;
	}else{
	 	console.log(c);
	 	createCookie(name, Number(c)+updateBy, expiry_in_a_month);
	}
	return Number(c)+updateBy;
}

/*
	Return the value of cookie, or null
*/
function readCookie(name) {
	var storedValue = localStorage.getItem(name);
	if (storedValue){
		let infos = storedValue.toString().split(';');
		let value = infos[0];
		let validUntil = new Date(infos[1]);
		let today = new Date();
		if (today<=  validUntil)
			return value;
		else{
			localStorage.removeItem(name);
			return null;
		}
	}else
		return null;
}

function readCookieOld(name) {
    var nameEQ = name + "=";
    var decodedCookie = decodeURIComponent(document.cookie);
    var cookies = decodedCookie.split(';');
    for (var i = 0; i < cookies.length; i++) {
        var c = cookies[i];
        while (c.charAt(0) == ' '){
            c = c.substring(1);
        }
        if (c.indexOf(nameEQ) === 0)
            return c.substring(nameEQ.length, c.length);
    }
    return null;
}


/*
	Remove the variable from local storage
*/
function removeCookie(name) {
	localStorage.removeItem(name);
}

/*
	Callback when "Next" in Rating section is clicked.
*/
function showNextQuestionInRatingSection(){
	var count = $("#nav-tab-ul li").length;
	id=$("#nav-tab-ul li.active").index();
	if (id+2==count){
		$('#next-rating').addClass('disabled');
	}
	id=id+2;
	$('#nav-tab-ul li:nth-child('+id+') a').tab('show');

}

/*
	Callback when "Previous" in Rating section is clicked.
*/
function showPreviousQuestionInRatingSection(){
	id=$("#nav-tab-ul li.active").index();
	id=id;
	$('#nav-tab-ul li:nth-child('+id+') a').tab('show');
	var count = $("#nav-tab-ul li").length;
	if (id+1<=count)
		$('#next-rating').removeClass('disabled');
}

/*
	Callback when "Next" in Training section is clicked.
*/
function showNextQuestionInTrainingSection(){
	var count = $("#trainingTabs li").length;
	id=$("#trainingTabs li.active").index();
	if (id+1!=count){
		id=id+2;
		$('#trainingTabs li:nth-child('+id+') a').tab('show');
	}else{
		// last next is called
		setTimeout(function (){
			window.location.hash="navNextPre";
		},  50);
	}
}

/*
	Callback when "Previous" in Training section is clicked.
*/
function showPreviousQuestionInTrainingSection(){
	id=$("#trainingTabs li.active").index();
	id=id;
	$('#trainingTabs li:nth-child('+id+') a').tab('show');
}


var trainingStimulusPlayed;

/*
  If all training clips played until the end, add a cookie expiring after
  config.forceRetrainingInHours
*/
function playedAudioTraining(id){
	// parallel session check
	isAnyParallelSession();
	$('input[name="'+id+'"]').off('change');
	trainingQuestionNumber= id.substring(1);
	eval("trainingStimulusPlayed["+trainingQuestionNumber+"-1]=1;");
	console.log(trainingStimulusPlayed.reduce(getSum, 0))
	if (trainingStimulusPlayed.reduce(getSum, 0) ==  trainingStimulusPlayed.length){
		createCookie(config['cookieName']+"_training","un_important",config['forceRetrainingInHours']*60);
	}
	if ($('span[id="'+id+'"]').attr("data-src") == config['knownQuestionInTrainingUrl']){
		element = $('input[name="'+id+'"]');
		element.unbind();
		element.on('change', onValueChangeForTpQuestionInTraining);
	}
}

// help to calc the sum of elements in an array
function getSum(total, num) {
  return total + num;
}

//---------------- baudio.js -----------------
// All functions needed for custom audio playback
var audioElements=[];
function clickManager(event) {
	ae=event.data.ae;
	var id=event.data.id;
	if (ae.paused) {
		pauseAll();
		playAudio(ae);
	} else {
		pauseAudio(ae);
	}
};

function playAudio(audio){
	audio.play();
	var idT=audio.id;
	var id=idT.substring(6,idT.length);
	console.log(id);
	$("#baudio_s_"+id).removeClass("glyphicon-repeat");
	$("#baudio_s_"+id).removeClass("glyphicon-play");
	$("#baudio_s_"+id).addClass("glyphicon-pause");
	$("#baudio_"+id).addClass("btn-primary");
	$("#audio_n_play_"+id).val(parseInt($("#audio_n_play_"+id).val())+1);
}

function pauseAudio(audio){
	audio.pause();
	var idT=audio.id;
	var id=idT.substring(6,idT.length);
	$("#baudio_s_"+id).removeClass("glyphicon-pause");
	$("#baudio_"+id).removeClass("btn-primary");
	$("#baudio_s_"+id).addClass("glyphicon-play");
}

function pauseAll(){
	for (i = 0; i < audioElements.length; i++) {
		if (!audioElements[i].paused){
			pauseAudio(audioElements[i]);
		}
	}
}

function canPlay(event){
	var ae=this;
	var idText =this.id;
	var id=idText.substring(6,idText.length);
	$("#baudio_l_d_"+id).text(" / " + (ae.duration).toString().toMMSS());
	$("#baudio_"+id).removeClass("disabled");
}

function timeUpdate(){
	var ae=this;
	var idText =this.id;
	var id=idText.substring(6,idText.length);
	$("#baudio_l_c_"+id).text(ae.currentTime.toString().toMMSS());
}

function isended(){
	var ae=this;
	var idText =this.id;
	var id=idText.substring(6,idText.length);

	$("#baudio_s_"+id).removeClass("glyphicon-pause");
	$("#baudio_"+id).removeClass("btn-primary");
	$("#baudio_s_"+id).addClass("glyphicon-repeat");
	$("#audio_n_finish_"+id).val(parseInt($("#audio_n_finish_"+id).val())+1);
	if ($("#"+id).attr('data-onfinished')){
		window[$("#"+id).attr('data-onfinished')](id);
	}
}

// loading all baudio elements in the page
$(function() {
    $( ".baudio" ).each(function(){
		titleTextTemplate='<tr><td>{1}</td></tr>';
		insert='';
		title='';
		a='<audio id="audio_{0}" preload="true"><source src="{1}" type="audio/wav"> </audio>'+
		'<input type="hidden" id="audio_n_play_{0}" name="audio_n_play_{0}" value="0">'+
		'<input type="hidden" id="audio_n_finish_{0}" name="audio_n_finish_{0}" value="0">';
		if ($(this).attr('title')){
			insert=titleTextTemplate;
			title=$(this).attr('title');
		}

		t='<table class="baudio_table" border="0">'+insert+' <tr><td><button id="baudio_{0}" type="button" class="btn bn disabled"><span id ="baudio_s_{0}" class="glyphicon glyphicon-play"></span></button></td></tr><tr><td><span id="baudio_l_c_{0}" class="blabel" >00:00</span><span id="baudio_l_d_{0}" class="blabel" > / 00:00</span></td></tr></table>';
		src=$(this).attr('data-src');
		id=$(this).attr('id');

		$(this).append(a.f(id,src));
		$(this).append(t.f(id,title));
		var audioElement = document.getElementById("audio_"+id);
		//save for later
		audioElements.push(audioElement);
		$( "#baudio_"+id ).click({ae: audioElement, id: id},clickManager);
		$( "#baudio_"+id ).disabled=false;
		audioElement.addEventListener("canplay",canPlay.bind(audioElement),false);
		audioElement.addEventListener("timeupdate",timeUpdate.bind(audioElement),false);
		audioElement.addEventListener("ended",isended.bind(audioElement),false);
	});

	$("source").on("error", function (e) {
        console.log("Error at audio tag level!"+e.target.src);
        problematic_urls=problematic_urls+"<li>"+e.target.src+"</li>";
        //$("#error_details").html(problematic_urls);
        recordError("on loading audio clips",e.target.src);
        //$("#error_loading_files").show();
    });
});
var problematic_urls="";
/*
	Called when the scale item is clicked
*/
function alertForbiddenChange(){
	alert('You should listen until the end.');
	$(this).prop('checked', false);
}

/*
	Users should not be able to vot before listening the audio clips until the end.
*/
function avoidAnsweringBeforeListeningThrough(){
	var i;
	// Training section
	for (i = 0; i < config['trainingUrls'].length; i++) {
		$('input[name="t{0}"]'.f(i+1)).on('change', alertForbiddenChange);
	}
	// Rating section
	for (i = 0; i < config['questionUrls'].length; i++) {
		$('input[name="q{0}"]'.f(i+1)).on('change', alertForbiddenChange);
	}
}

/*
	Listener on value change for the Gold question.
	if the answer is correct, change the value of gq_check to 0.
*/
function onValueChangeForGoldQuestion(){
	let ans = $( this ).val()
	let expectedVal = parseInt(config['goldClipAns'])
	if ( expectedVal -1 <=ans && ans <= expectedVal +1 )
		$('#gq_check').val(0);
	else
		$('#gq_check').val(-1);
	console.log($('#gq_check').val())
}

/*
	Listener on value change for the trapping question.
	if the answer is correct, change the value of tp_check to 0.
*/
function onValueChangeForTpQuestion(){
	if ($( this ).val()  == parseInt(config['knownQuestionAns']))
		$('#tp_check').val(0);
	else
		$('#tp_check').val(-1);
	//console.log("gc_check"+$('#tp_check').val())
}

/*
	Listener on value change for the trapping question in training.
	if the answer is wrong, show a message.
*/
function onValueChangeForTpQuestionInTraining(){
	if ($( this ).val()  != config['knownQuestionInTrainingAns']){
		alert('Error: In case you hear an interruption message, please follow the instruction given in the message.');
		$(this).prop('checked', false);
	}

}

/*
	Called when the audio in rating section by the given id is completely played.
	Now user can rate the quality.
*/
function playedAudioQ(id){
	// parallel session check
	isAnyParallelSession();
	// check if it was the trapping question
	if ($('span[id="'+id+'"]').attr("data-src") == config['knownQuestionUrl']){
		element = $('input[name="'+id+'"]');
		element.unbind();
		element.on('change', onValueChangeForTpQuestion);
	}else if ($('span[id="'+id+'"]').attr("data-src") == config['goldClipURL']){
		element = $('input[name="'+id+'"]');
		element.unbind();
		element.on('change', onValueChangeForGoldQuestion);
	}else{
		$('input[name="'+id+'"]').off('change');
		// check if already this HIT is counted
		if (!hitCounterIncreased){
			updateCounterCookie(config['cookieName']+"_counter",1);
			hitCounterIncreased=true
		}
	}
}

/*
	Called when user answers to one question from setup
	(i.e. q2. math question). Here the cookie will be added/updated
*/
function userAnsweringToSetupQuestions(){
	createCookie(config['cookieName']+"_setup","un_important",config['showSetupEveryMinutes']);
	$('input[name="math"]').off('change');
}

</script>

<script type="text/javascript">

/*
	functions responsible to headset check
*/
function isHeadsetOn(webrtc_raw){
	keywords= ["headphone",  "headset","airpod", "usb audio device"]
	for (var i = 0; i < keywords.length; i++) {
		if (webrtc_raw.includes(keywords[i]))
			return true;
	}
	return false;
}

const constraints = {
  	audio: true,
	video:false
};

/*
	Async function to check the list of audio devices when the user allowed
*/
const startHeadsetCheck = async function() {
	$('#status').html("waiting for allowance...")
    await navigator.mediaDevices.getUserMedia(constraints);

    navigator.mediaDevices.enumerateDevices()
    .then(devices => {
        var device_list= "";
        for (var i=0;i<devices.length;i++){
        	if (devices[i].kind.startsWith('audio')){
    			device_list = device_list+ devices[i].kind + ":" +devices[i].label.toLowerCase() +"+";
    		}
        }
        headsetDetected=isHeadsetOn(device_list);
        $( "#webrtc_raw" ).val(device_list);
        $( "#use_headset" ).val(headsetDetected);
		$( "#status" ).html("Done. Please continue.");
  });
}

//function startMeasure(){
// 	startHeadsetCheck();
//}
</script>

<script type="text/javascript">

/*
	shuffle function for randomization of items -->
*/
function shuffle(a) {
	var j, x, i;
	for (i = a.length - 1; i > 0; i--) {
		j = Math.floor(Math.random() * (i + 1));
		x = a[i];
		a[i] = a[j];
		a[j] = x;
	}
	return a;
}

/*
	Generate the training section
*/
function generate_training_section(){
	acr_nav_tab = '<li class="nav-item {1}"><a class="nav-link " data-toggle="tab"  href="#T{0}-panel" id="T{0}-tab " role="tab" aria-controls="T{0}" {2}>Q. {0}</a></li>';
	acr_tab ='<div class="tab-pane fade {2}" id="T{0}-panel" role="tabpanel" aria-labelledby="T{0}-tab"><p></p><div class="row">	<div class="col-sm-3"></div>	<div class="col-sm-6">		<p style="margin-top:10px;">{0}. How do you rate the <b>overall quality</b> of the following speech samples? </p><p align="center"> <span class="baudio" id="t{0}" data-onfinished="playedAudioTraining" data-src="{1}" >&nbsp;</span> </p><fieldset id="fieldset_t{0}" class="trainingFieldset" title=""><table class="table md scale" cellspacing="0" cellpadding="0">			<thead><tr><th >Overall quality of the sample</th><th class="c" >Score</th></tr>			</thead>			<tbody><tr><td><div class="radio" ><label ><input type="radio" name="t{0}" value="5">Excellent</label></div></td><td class="c">5</td></tr><tr><td><div class="radio" ><label ><input type="radio" name="t{0}" value="4">Good</label></div></td><td class="c">4</td></tr><tr><td><div class="radio" ><label ><input type="radio" name="t{0}" value="3">Fair</label></div></td><td class="c">3</td></tr><tr><td><div class="radio" ><label ><input type="radio" name="t{0}" value="2">Poor</label></div></td><td class="c">2</td></tr><tr><td><div class="radio" ><label ><input type="radio" name="t{0}" value="1"required="">Bad</label></div></td><td class="c">1</td></tr>	   </tbody></table>		</fieldset><p></p> </div> 	<div class="col-sm-3"></div></div> <p></p> </div>';
	// this will show which url was shown by in which question as their orther will be randomized
	input_template= '<input id="T{0}_URL" name="T{0}_URL" type="hidden" value="{1}" />';

    if (JSON.parse(config['randomizeTrainingQuestions']))
		urls = shuffle(config['trainingUrls']);
	else
		urls = config['trainingUrls'];

	var i;
	for (i = 0; i < urls.length; i++) {
		if (i==0){
			$('#trainingTabs').append(acr_nav_tab.f(i+1,'active', 'ria-selected="true"'));
			$('#nav-tabContent').append(acr_tab.f(i+1, urls[i],'in active'));
		}else{
			$('#trainingTabs').append(acr_nav_tab.f(i+1,'',''));
			$('#nav-tabContent').append(acr_tab.f(i+1, urls[i],''));
		}
		$('#av-tabContent').append(input_template.f(i+1, urls[i]));
	}
	$('.question_number_training').html(urls.length);
	trainingStimulusPlayed = new Array(urls.length).fill(0);
}

/*
	Generate rating section
*/
function generate_rating_section(){
    // Define the template for each audio sample and its rating options
    var audioRatingTemplate = `
        <div class="audio-rating">
            <audio controls>
                <source src="{1}" type="audio/wav">
                Your browser does not support the audio element.
            </audio>
            <div class="rating-options">
                <label><input type="radio" name="q{0}" value="1"> 1 - Completely unnatural</label>
                <label><input type="radio" name="q{0}" value="2"> 2</label>
                <label><input type="radio" name="q{0}" value="3"> 3 - Somewhat natural</label>
                <label><input type="radio" name="q{0}" value="4"> 4</label>
                <label><input type="radio" name="q{0}" value="5"> 5 - Completely natural</label>
            </div>
        </div>
    `;

    // Determine the URLs to use based on configuration
    var urls = JSON.parse(config['randomizeRatingQuestions']) ? shuffle(config['questionUrls']) : config['questionUrls'];

    // Clear existing content and add the question text
    $('#nav-tabContent-rating').empty().append('<p>Question 1. How do you rate the <b>overall quality</b> of the following speech sample?</p>');

    // Append each audio sample and its rating options to the container
    for (var i = 0; i < urls.length; i++) {
        $('#nav-tabContent-rating').append(audioRatingTemplate.replace(/\{0\}/g, i+1).replace(/\{1\}/g, urls[i]));
    }

    // Update the total number of questions displayed
    $('.question_number').html(urls.length);
}
</script>

<!--    Error -->
<section class="container" id="errorSection" hidden>
	<div class="alert alert-danger" role="alert" >
		<h5>Error</h5>
		<p>One or more errors are detected during loading this HIT. Please use the following link to send the error to us: <a class="email"  id="errorEmail"title="Email in HIT" href="">Email</a>.</p>
		<p><b> Meanwhile, please return this HIT and try another one</b>.</p>
	</div>
</section>

<!-- Instructions -->
<section class="container" id="Survey">
	<div class="panel panel-primary">
		<div class="panel-heading">
			<h3 class="panel-title">
				<a data-target="#instruction" data-toggle="collapse">Evaluating Overall Audio Quality</a>
			</h3>
		</div>
		<div class="panel-collapse collapse in" id="instruction">
			  <div class="panel-body">
				<p>
					Hello! We need your help to evaluate subjective quality of audio pieces. You will be given 5 sets of questions, and it will take you ~10 minutes to finish. In each of the following task, we show you a piece of audio and ask you to rate its overall quality from 1 to 5. Please evaluate from the perspective of sound naturalness and realisticity, make sure to check the scoring guidance in the following table:</p>
				<p>
					<b>Scoring Guidance:</b></p>
				<ul>
					<li>1 - Bad (Completely unnatural audio) - Composed of background noise, unnatural sound patterns, low quality audio. Does not sound like a real world recording.</li>
					<li>2 - Poor (Mostly unnatural audio) - Large amount of background noise, unnatural sound patterns, low quality audio.</li>
					<li>3 - Fair (Somewhat natural audio) - Moderate background noise, some unnatural sound patterns, average audio quality.</li>
					<li>4 - Good (Mostly natural audio) - Real world audio with good quality, may contain some unnatural patterns.</li>
					<li>5 - Excellent (Completely natural audio) - High quality real world recording.</li>
				</ul>

				<p>
					You might hear similar content, but please be aware that every sample is different and you should score each sample accordingly. Different samples can receive same score if the quality are similar.</p>
				<p>

				<p><b>Payment:</b></p>
				<p>The result of this experiment is <b>very important for us and other scientist</b> working in this area. We have methods that analyse the consistency of your answers. We will use these methods to rank the submitted assignments according to quality.</p>
				<p>For this experiment, we will pay a base reward of <b>$0.5/HIT</b> for every accepted HIT. </p>

				  <p></p>
			</div>
		</div>

	</div>
</section>


<!-- Qualification -->
<section class="container" id="qualification">
    <div class="row col-xs-12 col-md-12">
        <div class="panel panel-info">
            <div class="panel-heading">
                <h3 class="panel-title">
                    <a data-toggle="collapse" href="#collapse1">Qualification - Just once</a>
                </h3>
            </div>
            <div id="collapse1" class="panel-collapse collapse in">
                <div class="panel-body">
                    <div style="text-align: center;margin:30px;"> 
                        <img src="https://audiosamplesp808.blob.core.windows.net/p808-assets/img/attention.png" alt="attention">  
                        <b>Please wear your headphones now.</b>
                    </div>
                    <fieldset class="qualificationFieldset">
                        <label>9.&nbsp;Before we begin the audio evaluation, please set the volume of your computer to a comfortable level to ensure you can hear the upcoming audio sample clearly. As you listen to the sample, could you indicate which side of your headphones the audio is coming from?</label>
                        <p align="center"> 
                            <span class="baudio" id="volume" data-src="https://data.csail.mit.edu/placesaudio/codec_resyn/for_mos/egs/stereo.wav">&nbsp;</span> 
                        </p>
                        <div class="alert alert-warning" role="alert">
                            <b>NOTE:</b> After that, you are not allowed to change the volume anymore. Otherwise your response will be rejected.
                        </div>
                    </fieldset>
                    <!-- Headphone Check -->
                    <fieldset class="qualificationFieldset">
                        <label>Please select which side you hear the sound from:</label>
                        <div align="center">
                            <div class="radio">
                                <label><input type="radio" name="headphoneCheck" value="Left" required onchange="userAnsweringToQualificationQuestions()"> Left</label>
                            </div>
                            <div class="radio">
                                <label><input type="radio" name="headphoneCheck" value="Right" required onchange="userAnsweringToQualificationQuestions()"> Right</label>
                            </div>
                            <div class="radio">
                                <label><input type="radio" name="headphoneCheck" value="Both" required onchange="userAnsweringToQualificationQuestions()"> Both</label>
                            </div>
                        </div>
                    </fieldset>
                </div>
            </div>
        </div>
    </div>
</section>
	
			
	
	
	<!-- Setup -->
	

	<!-- Setup  ends-->
	
	<!-- Device Check -->
	
	<!-- Device Check ends-->
	
	<!-- Training section, appears once a day-->
	
	<!-- Training section ends-->
	
<!--- Rating task -->
<section class="container" id="rating_section">
		<div class="panel panel-primary">
			<div class="panel-heading">
				<h3 class="panel-title">Ratings</h3>
			</div>
			<div class="panel-body">
				<p> For each of the audio below, rate the sound quality (naturalness and realisticity) on a scale from 1-5. <b>Note</b> that the scale will be activated when the speech sample played until the end. In case you hear an interruption message, please follow the instruction given in the message.</p>
				

 				<!-- will be generated -->
				<ul class="nav nav-tabs" role="tablist" id="nav-tab-ul"> </ul>
				<!-- will be generated -->
				<div class="tab-content" id="nav-tabContent-rating">	</div>
				<div style="margin-top:0px;font-size:90%;text-align:center">Click <b>next</b> to answer all <b class="question_number">0</b> questions, then submit your response.</div>
				<nav aria-label="..." id="navNextPre">
				  <ul class="pager">
					<li class="previous" id="prev-rating" onclick="showPreviousQuestionInRatingSection();"><a href="#navNextPre" class="page-link"  role="button" ><span aria-hidden="true">&larr;</span>Previous</a></li>
					<li class="next" id= "next-rating" onclick="showNextQuestionInRatingSection();" ><a href="#navNextPre" class="page-link"  role="button">Next <span aria-hidden="true">&rarr;</span></a></li>
				  </ul>
				</nav>

			</div>
		</div>
</section>


<section class="container" id="thanks">
	<p>Thanks for your participation. Please perform more HITs from this group when they are available for you.</p>
</section>

<section class="container" id="max_allowed_HITs_reached" hidden>
	<p><h2>Well done! </h2> You performed the maximum number of HITs that you were allowed to.</p>

	<div class="alert alert-danger" role="alert">
		<img src="https://audiosamplesp808.blob.core.windows.net/p808-assets/img/attention.png" alt="attention">
			  <b>NOTE:</b> Performing more HITs
		than what is explained in the description is forbidden and leads ro rejection of all of your submissions.
			</div>

</section>

<section class="container" id="qualification_rejected" hidden>
	<p>There is no assignments that match to your profile now. Please try it again in two-weeks time.
	We thank you for your participation.</p>

	<div class="alert alert-danger" role="alert">
		<img src="https://audiosamplesp808.blob.core.windows.net/p808-assets/img/attention.png" alt="attention">
			  <b>NOTE:</b> Any try to perform assignments and neglecting this message is forbidden and leads ro rejection of all of your submissions.
			</div>
</section>
